<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<title>Recomendaciones de Muestras</title>
<style>
  body { font-family: Arial, sans-serif; margin: 20px; }
  label { display: block; margin-top: 10px; }
  .resultado { margin-top: 20px; }
  table { border-collapse: collapse; margin-top: 10px; width: 100%; max-width: 600px;}
  th, td { border: 1px solid #ccc; padding: 8px; text-align: center;}
  th { background: #eee; }
  .tomada { background-color: #c8e6c9; } /* verde claro */
  .pendiente { background-color: #ffcdd2; } /* rojo claro */
</style>
</head>
<body>

<h2>Calculadora de recomendaciones de muestras</h2>

<form id="formulario">
  <label>
    Unidad:
    <select id="unidad" required>
      <option value="">Seleccione</option>
      <option value="uci">UTI-UCI</option>
      <option value="puericultura">Puericultura / Neonatología</option>
    </select>
  </label>

  <label>
    Edad gestacional (semanas):
    <input type="number" id="edadGestacional" min="20" max="45" required />
  </label>

  <label>
    Peso al nacer (gramos):
    <input type="number" id="peso" min="500" max="6000" required />
  </label>

  <label>
    Transfusión previa a M1:
    <input type="checkbox" id="transfusion" />
  </label>

  <label>
    Diagnóstico o sospecha de Síndrome de Down:
    <input type="checkbox" id="sindromeDown" />
  </label>

  <label>
    Fecha de nacimiento:
    <input type="date" id="fechaNacimiento" required />
  </label>

  <fieldset>
    <legend>Fechas de toma de muestras realizadas (si ya las tienen):</legend>

    <label><input type="checkbox" id="m0_check" /> Muestra 0 (M0) <input type="date" id="fechaM0" /></label>
    <label><input type="checkbox" id="m1_check" /> Muestra 1 (M1) <input type="date" id="fechaM1" /></label>
    <label><input type="checkbox" id="m2_check" /> Muestra 2 (M2) <input type="date" id="fechaM2" /></label>
    <label><input type="checkbox" id="m3_check" /> Muestra 3 (M3) <input type="date" id="fechaM3" /></label>
    <label><input type="checkbox" id="m3a_check" /> Muestra 3a (M3a) <input type="date" id="fechaM3a" /></label>
    <label><input type="checkbox" id="m3b_check" /> Muestra 3b (M3b) <input type="date" id="fechaM3b" /></label>
  </fieldset>

  <button type="button" onclick="calcularRecomendacion()">Calcular recomendación</button>
</form>

<div id="resultado" class="resultado"></div>

<script>
function calcularRecomendacion() {
  const unidad = document.getElementById("unidad").value;
  const edadGestacional = Number(document.getElementById("edadGestacional").value);
  const peso = Number(document.getElementById("peso").value);
  const transfusion = document.getElementById("transfusion").checked;
  const sindromeDown = document.getElementById("sindromeDown").checked;
  const fechaNacimientoStr = document.getElementById("fechaNacimiento").value;

  if (!unidad || !fechaNacimientoStr || !edadGestacional || !peso) {
    alert("Por favor completa todos los datos obligatorios.");
    return;
  }

  const fechaNacimiento = new Date(fechaNacimientoStr);

  // Función para calcular diferencia en días entre dos fechas
  function diasEntre(f1, f2) {
    const diffMs = f2 - f1;
    return diffMs / (1000*60*60*24);
  }

  // Obtener fechas de muestras si fueron tomadas
  function getFechaMuestra(idCheck, idFecha) {
    const check = document.getElementById(idCheck).checked;
    const fechaStr = document.getElementById(idFecha).value;
    if (check && fechaStr) return new Date(fechaStr);
    return null;
  }

  const fechasTomadas = {
    m0: getFechaMuestra("m0_check", "fechaM0"),
    m1: getFechaMuestra("m1_check", "fechaM1"),
    m2: getFechaMuestra("m2_check", "fechaM2"),
    m3: getFechaMuestra("m3_check", "fechaM3"),
    m3a: getFechaMuestra("m3a_check", "fechaM3a"),
    m3b: getFechaMuestra("m3b_check", "fechaM3b"),
  };

  // --- Lógica de recomendaciones según algoritmo ---

  let recomendaciones = [];

  // Siempre se toma M0 si UCI
  if (unidad === "uci") {
    recomendaciones.push({
      muestra: "M0",
      rango: "Al ingreso a UCI (ideal antes de 40 h)",
      fechaRecomendada: fechaNacimiento,
      motivo: "Toma de muestra al ingresar a la unidad UCI."
    });

    // M1 si M0 tomada antes de 40h
    if (fechasTomadas.m0) {
      const horasVidaM0 = (fechasTomadas.m0 - fechaNacimiento) / (1000*60*60);
      if (horasVidaM0 < 40) {
        // Recomendar M1 entre 48-72h
        let fechaM1Desde = new Date(fechaNacimiento.getTime() + 48*60*60*1000);
        recomendaciones.push({
          muestra: "M1",
          rango: "Entre 48-72 horas de vida",
          fechaRecomendada: fechaM1Desde,
          motivo: "Muestra de seguimiento para recién nacido en UCI con M0 < 40h."
        });
      }
    }

    // M2 para pretérminos, bajo peso o transfusión previa a M1
    if (edadGestacional < 37 || peso < 2500 || transfusion) {
      let fechaM2 = new Date(fechaNacimiento.getTime() + 28*24*60*60*1000);
      recomendaciones.push({
        muestra: "M2",
        rango: "A los 28 días de vida o al alta, lo que ocurra primero",
        fechaRecomendada: fechaM2,
        motivo: "Muestra para pretérmino, bajo peso o transfusión previa."
      });
    }

    // M3a y M3b casos excepcionales
    // Primero detectamos la muestra previa al alta:
    // Para esto asumimos que la última muestra tomada antes del alta es la de mayor fecha entre m0, m1, m2, m3, m3a, m3b que exista.
    // Para este ejemplo, definiremos "previa al alta" como la última muestra tomada (fecha mayor) pero antes del alta (suponemos alta >28 días si no se ingresa explicitamente)

    // Encontrar última muestra tomada antes de 28 días
    let muestrasPrevias = ["m0", "m1", "m2", "m3", "m3a", "m3b"];
    let ultimaMuestraFecha = null;
    muestrasPrevias.forEach(m => {
      const f = fechasTomadas[m];
      if (f && (ultimaMuestraFecha === null || f > ultimaMuestraFecha)) {
        ultimaMuestraFecha = f;
      }
    });

    if (ultimaMuestraFecha) {
      const diasUltimaMuestra = diasEntre(fechaNacimiento, ultimaMuestraFecha);

      // M3a: recién nacidos con muestra previa antes de 10 días y criterios de bajo peso o pretérmino o transfusión antes de 7 días previa al alta
      if (diasUltimaMuestra < 10 && (edadGestacional < 37 || peso < 2500 || (transfusion && diasUltimaMuestra <= 7))) {
        let fechaM3a = new Date(fechaNacimiento.getTime() + 15*24*60*60*1000);
        recomendaciones.push({
          muestra: "M3a",
          rango: "A los 15 días de vida",
          fechaRecomendada: fechaM3a,
          motivo: "Muestra excepcional para pretérmino, bajo peso o transfusión reciente con muestra previa antes de 10 días."
        });
      }

      // M3b: recién nacidos con Síndrome de Down con muestra previa antes de 21 días
      if (sindromeDown && diasUltimaMuestra < 21) {
        let fechaM3b = new Date(fechaNacimiento.getTime() + 21*24*60*60*1000);
        recomendaciones.push({
          muestra: "M3b",
          rango: "Antes de los 21 días de vida",
          fechaRecomendada: fechaM3b,
          motivo: "Muestra excepcional para recién nacido con Síndrome de Down con muestra previa al alta antes de 21 días."
        });
      }
    }
  }
  else if (unidad === "puericultura") {
    // Para recién nacidos en puericultura o neonatología (no UCI)

    // M1 entre 40-48 horas
    let fechaM1 = new Date(fechaNacimiento.getTime() + 40*60*60*1000);
    recomendaciones.push({
      muestra: "M1",
      rango: "Entre 40-48 horas de vida",
      fechaRecomendada: fechaM1,
      motivo: "Primera muestra para recién nacido hospitalizado en puericultura."
    });

    // M2 a los 15 días para pretérminos o bajo peso
    if (edadGestacional < 37 || peso < 2500) {
      let fechaM2 = new Date(fechaNacimiento.getTime() + 15*24*60*60*1000);
      recomendaciones.push({
        muestra: "M2",
        rango: "A los 15 días de vida",
        fechaRecomendada: fechaM2,
        motivo: "Muestra para pretérmino o bajo peso."
      });
    }

    // M3 a los 28 días para síndrome de Down
    if (sindromeDown) {
      let fechaM3 = new Date(fechaNacimiento.getTime() + 28*24*60*60*1000);
      recomendaciones.push({
        muestra: "M3",
        rango: "A los 28 días de vida",
        fechaRecomendada: fechaM3,
        motivo: "Muestra para recién nacido con Síndrome de Down."
      });
    }
  } else {
    alert("Unidad no válida.");
    return;
  }

  // --- FIN LÓGICA DE RECOMENDACIONES ---

  // Mostrar recomendaciones en texto y tabla

  let texto = `<h3>Recomendaciones para muestras según algoritmo:</h3><ul>`;

  recomendaciones.forEach(r => {
    texto += `<li><b>${r.muestra}</b>: ${r.rango} (fecha recomendada: <b>${r.fechaRecomendada.toISOString().slice(0,10)}</b>). <br>Motivo: ${r.motivo}</li>`;
  });

  texto += `</ul>`;

  // Ahora el control de muestras tomadas y pendientes (solo para las recomendadas)

  texto += `<h3>Control de muestras realizadas:</h3>`;

  // Filtrar sólo las muestras recomendadas para mostrar control
  const muestrasRecomendadas = recomendaciones.map(r => r.muestra);

  // Para cada muestra recomendada, chequear si fue tomada, si cumple rango y si está pendiente
  texto += `<table><thead><tr><th>Muestra</th><th>Fecha tomada</th><th>Estado</th><th>Observaciones</th></tr></thead><tbody>`;

  recomendaciones.forEach(r => {
    const fTomada = fechasTomadas[r.muestra.toLowerCase()];
    let estado = "Pendiente";
    let observacion = "";

    if (fTomada) {
      estado = "Tomada";
      // Verificar si fecha tomada está dentro de +/- 20% del rango esperado (aprox)
      // Como los rangos son amplios, aquí sólo verificamos si fue tomada después de la fecha recomendada
      if (fTomada < r.fechaRecomendada) {
        observacion = `Muestra tomada antes de la fecha recomendada.`;
      } else if (fTomada > r.fechaRecomendada) {
        observacion = `Muestra tomada después de la fecha recomendada.`;
      } else {
        observacion = `Muestra tomada en fecha recomendada.`;
      }
    } else {
      estado = "Pendiente";
      observacion = "Muestra pendiente.";
    }

    texto += `<tr class="${estado.toLowerCase()}"><td>${r.muestra}</td><td>${fTomada ? fTomada.toISOString().slice(0,10) : "-"}</td><td>${estado}</td><td>${observacion}</td></tr>`;
  });

  texto += `</tbody></table>`;

  // Mostrar también muestras tomadas que no están recomendadas por algoritmo

  const muestrasNoRecomendadas = Object.keys(fechasTomadas).filter(m => fechasTomadas[m] && !muestrasRecomendadas.includes(m.toUpperCase()));

  if (muestrasNoRecomendadas.length > 0) {
    texto += `<h3>Muestras tomadas no recomendadas por algoritmo:</h3><ul>`;
    muestrasNoRecomendadas.forEach(m => {
      texto += `<li><b>${m.toUpperCase()}</b> tomada el <b>${fechasTomadas[m].toISOString().slice(0,10)}</b>, pero no cumple criterios para ser tomada según algoritmo.</li>`;
    });
    texto += `</ul>`;
  }

  // Mostrar resultado final

  document.getElementById("resultado").innerHTML = texto;

}

</script>

</body>
</html>



