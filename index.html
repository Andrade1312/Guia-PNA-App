document.addEventListener("DOMContentLoaded", () => {
  // Elementos UI
  const unidad = document.getElementById("unidadIngreso");
  const edadGestacional = document.getElementById("edadGestacional");
  const peso = document.getElementById("pesoNacimiento");
  const sindromeDown = document.getElementById("sindromeDown");
  const condUti = document.getElementById("condicionales-uti-uci");
  const condM3a = document.getElementById("condicionales-m3a");
  const recibioM0 = document.getElementById("recibioM0");
  const m0Tiempo = document.getElementById("m0-tiempo-group");
  const m0Menos40h = document.getElementById("m0Menos40h");
  const transfusionPreviaM1 = document.getElementById("transfusionPreviaM1");
  const pesquisaDudosaM1 = document.getElementById("pesquisaDudosaM1");
  const muestraPreviaAltaMenos10Dias = document.getElementById(
    "muestraPreviaAltaMenos10Dias"
  );
  const transfusionMenos7Dias = document.getElementById("transfusionMenos7Dias");
  const fechaNacimiento = document.getElementById("fechaNacimiento");
  const resultadosDiv = document.getElementById("resultados");

  const fechasTomadas = {
    M0: document.getElementById("fechaM0"),
    M1: document.getElementById("fechaM1"),
    M2: document.getElementById("fechaM2"),
    M3: document.getElementById("fechaM3"),
  };

  // Mostrar / ocultar controles según unidad y checkboxes
  const actualizarCondicionales = () => {
    const esUti = unidad.value === "uti_uci";
    condUti.style.display = esUti ? "block" : "none";
    condM3a.style.display = esUti ? "block" : "none";
    m0Tiempo.style.display = esUti && recibioM0.checked ? "flex" : "none";
  };
  unidad.addEventListener("change", actualizarCondicionales);
  recibioM0.addEventListener("change", actualizarCondicionales);
  actualizarCondicionales();

  // Diferencia en días entre dos fechas (f2 - f1)
  const diasEntre = (f1, f2) => {
    if (!f1 || !f2) return NaN;
    const d1 = new Date(f1);
    const d2 = new Date(f2);
    return (d2 - d1) / (1000 * 60 * 60 * 24);
  };

  // Sumar días a una fecha (yyyy-mm-dd), devuelve yyyy-mm-dd
  const sumarDias = (fechaStr, dias) => {
    if (!fechaStr) return null;
    const fecha = new Date(fechaStr);
    fecha.setDate(fecha.getDate() + dias);
    return fecha.toISOString().slice(0, 10);
  };

  // Validar inputs mínimos necesarios
  const validarInputs = () => {
    const eg = parseInt(edadGestacional.value);
    const pesoVal = parseInt(peso.value);
    const nac = fechaNacimiento.value;
    if (!nac) return "Debes ingresar la Fecha de Nacimiento.";
    if (isNaN(eg)) return "Debes ingresar una Edad Gestacional válida.";
    if (isNaN(pesoVal)) return "Debes ingresar un Peso de Nacimiento válido.";
    return null;
  };

  // Calcular edad en días desde fechaNacimiento a fecha dada
  const edadEnDias = (fecha) => {
    if (!fechaNacimiento.value || !fecha) return NaN;
    return diasEntre(fechaNacimiento.value, fecha);
  };

  document.getElementById("calcularBtn").addEventListener("click", () => {
    const error = validarInputs();
    if (error) {
      resultadosDiv.innerHTML = `<p class="error">⚠️ ${error}</p>`;
      return;
    }

    const eg = parseInt(edadGestacional.value);
    const pesoVal = parseInt(peso.value);
    const nac = fechaNacimiento.value;
    const esUti = unidad.value === "uti_uci";

    // Reiniciar array de muestras recomendadas
    let muestras = [];

    // ---- Lógica según Unidad ----
    if (!esUti) {
      // a) Puerperio/Puericultura/Cuidados Básicos
      // M1: 40-48h (1.7 - 2 días) - siempre
      muestras.push({
        id: "M1",
        descripcion: "Primera muestra entre 40–48 h de vida",
        diaRecomendado: 2, // 48h
      });

      // M2: a los 15 días si pretermino o bajo peso
      if (eg < 37 || pesoVal < 2500) {
        muestras.push({
          id: "M2",
          descripcion: "Segunda muestra a los 15 días de vida (pretérmino o bajo peso)",
          diaRecomendado: 15,
        });
      }

      // M3: a los 28 días si Síndrome de Down
      if (sindromeDown.checked) {
        muestras.push({
          id: "M3",
          descripcion: "Tercera muestra a los 28 días (Síndrome de Down)",
          diaRecomendado: 28,
        });
      }

    } else {
      // b) UTI-UCI

      // M0: muestra al ingreso (día 0)
      muestras.push({
        id: "M0",
        descripcion: "Muestra al ingreso antes de tratamientos",
        diaRecomendado: 0,
      });

      // M1:
      // Si recibió M0 y esta fue < 40h, nueva muestra 48-72h
      if (recibioM0.checked && m0Menos40h.checked) {
        muestras.push({
          id: "M1",
          descripcion: "Nueva muestra entre 48 y 72 h si M0 fue <40h de vida",
          diaRecomendado: 3, // para mostrar fecha tope (72h = 3 días)
          diaMin: 2, // 48h
        });
      }
      // Si no recibió M0, tomar M1 entre 40-48h (2 días)
      else if (!recibioM0.checked) {
        muestras.push({
          id: "M1",
          descripcion: "Muestra entre 40–48 h (si no se tomó M0)",
          diaRecomendado: 2,
        });
      }

      // M2:
      // Si transfusión previa a M1 o pesquisa dudosa, nueva muestra a los 15 días desde M1
      if (
        (transfusionPreviaM1.checked || pesquisaDudosaM1.checked) &&
        fechasTomadas.M1.value
      ) {
        muestras.push({
          id: "M2",
          descripcion: "Muestra a los 15 días desde M1 por transfusión o pesquisa dudosa",
          diaRecomendado:
            edadEnDias(fechasTomadas.M1.value) + 15,
        });
      } else {
        // Si no, M2 a los 15 días de vida si pretermino o bajo peso
        if (eg < 37 || pesoVal < 2500) {
          muestras.push({
            id: "M2",
            descripcion: "Muestra a los 15 días de vida (pretérmino o bajo peso)",
            diaRecomendado: 15,
          });
        }
      }

      // M3b: según nueva condición (solo si sindromeDown y muestra previa al alta < 21 días)
      // Obtener edad en días de muestra previa al alta (M2)
      const edadM2 = fechasTomadas.M2.value ? edadEnDias(fechasTomadas.M2.value) : NaN;

      if (
        sindromeDown.checked &&
        fechasTomadas.M2.value &&
        edadM2 < 21
      ) {
        muestras.push({
          id: "M3b",
          descripcion: "Nueva muestra a los 28 días (Síndrome de Down con muestra previa <21 días)",
          diaRecomendado: 28,
        });
      } else {
        // M3a:
        // Si muestra previa antes del alta es menor a 10 días y transfusión < 7 días desde muestra, repetir muestra (M3a)
        if (
          muestraPreviaAltaMenos10Dias.checked &&
          transfusionMenos7Dias.checked &&
          fechasTomadas.M2.value
        ) {
          muestras.push({
            id: "M3a",
            descripcion:
              "Repetir muestra (M3a) por transfusión reciente y muestra previa < 10 días",
            diaRecomendado:
              edadEnDias(fechasTomadas.M2.value) + 7,
          });
        }
      }
    }

    // ---- Comprobar muestras tomadas y detectar errores ----
    // Revisar si el usuario colocó fecha en muestras no recomendadas y si fechas tomadas están fuera de rango
    const alertas = [];
    const muestrasRecomendadasIDs = muestras.map((m) => m.id);

    // Función para verificar si fecha tomada está dentro +/-1 día
    const esFechaCorrecta = (fechaTomada, diaRecomendado) => {
      if (!fechaTomada) return false;
      const diff = Math.abs(edadEnDias(fechaTomada) - diaRecomendado);
      return diff <= 1;
    };

    // Revisar todas las muestras M0-M3 en inputs
    ["M0", "M1", "M2", "M3"].forEach((id) => {
      const fechaT = fechasTomadas[id].value;
      if (fechaT) {
        if (!muestrasRecomendadasIDs.includes(id)) {
          alertas.push(`⚠️ La muestra ${id} no corresponde según el algoritmo, pero tiene fecha tomada.`);
        } else {
          // Si la muestra corresponde pero la fecha no está dentro del rango permitido
          const muestraObj = muestras.find((m) => m.id === id);
          if (!esFechaCorrecta(fechaT, muestraObj.diaRecomendado)) {
            alertas.push(`⚠️ La fecha tomada para la muestra ${id} está fuera del rango recomendado.`);
          }
        }
      }
    });

    // Construir texto informativo inicial con las muestras recomendadas
    let textoInfo = `<p><strong>Recomendación:</strong> El/la recién nacido/a tiene indicación para las siguientes muestras: <strong>${muestrasRecomendadasIDs.join(", ")}</strong>.</p>`;

    if (muestras.length > 0) {
      textoInfo += "<ul>";
      muestras.forEach((m) => {
        const fechaRec = sumarDias(nac, m.diaRecomendado);
        textoInfo += `<li>${m.id}: ${m.descripcion}, recomendada para el día ${m.diaRecomendado} (fecha aprox. ${fechaRec})</li>`;
      });
      textoInfo += "</ul>";
    }

    if (alertas.length > 0) {
      textoInfo += `<p style="color: red; font-weight: bold;">${alertas.join("<br>")}</p>`;
    }

    // ---- Mostrar resultados ----
    const hoy = new Date();
    const hoyStr = hoy.toISOString().slice(0, 10);

    let html = `<table>
      <thead>
        <tr>
          <th>Muestra</th>
          <th>Descripción</th>
          <th>Día recomendado desde nacimiento</th>
          <th>Fecha recomendada</th>
          <th>Fecha tomada</th>
          <th>Estado</th>
        </tr>
      </thead>
      <tbody>`;

    muestras.forEach((m) => {
      const fechaRec = sumarDias(nac, m.diaRecomendado);
      const fechaTomada = fechasTomadas[m.id]?.value || "-";

      let estado = "Pendiente";
      let claseEstado = "pending";
      let alertaExtra = "";

      if (fechaTomada && fechaTomada !== "-") {
        const dif = Math.abs(edadEnDias(fechaTomada) - m.diaRecomendado);
        if (dif <= 1) {
          estado = "Correcta";
          claseEstado = "ok";
        } else {
          estado = "Desviada ⚠️";
          claseEstado = "warning";
          alertaExtra = "⚠️";
        }
      } else {
        // Si no fecha tomada y fecha recomendada en pasado o hoy, pendiente
        if (fechaRec <= hoyStr) {
          estado = "Pendiente";
          claseEstado = "pending";
        } else {
          estado = "Programada";
          claseEstado = "";
        }
      }

      html += `<tr>
        <td>${m.id} ${alertaExtra}</td>
        <td>${m.descripcion}</td>
        <td>${m.diaRecomendado}</td>
        <td>${fechaRec || "-"}</td>
        <td>${fechaTomada}</td>
        <td class="${claseEstado}">${estado}</td>
      </tr>`;
    });

    resultadosDiv.innerHTML = textoInfo + html + "</tbody></table>";
  });
});


