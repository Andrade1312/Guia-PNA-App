<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Guía PNA de Tomas de Muestra</title>
<style>
  body {
    font-family: "Segoe UI", sans-serif;
    background: #f7f9fc;
    margin: 0;
    padding: 0;
    color: #333;
  }
  .container {
    background: white;
    max-width: 900px;
    margin: 30px auto;
    padding: 25px 35px;
    border-radius: 12px;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
  }
  h1 {
    text-align: center;
    color: #0056b3;
  }
  p.autor {
    text-align: center;
    font-style: italic;
    color: #444;
  }
  .input-group {
    margin: 12px 0;
  }
  label {
    font-weight: 600;
  }
  select,
  input[type="number"],
  input[type="date"] {
    width: 100%;
    padding: 8px;
    border-radius: 5px;
    border: 1px solid #ccc;
  }
  button {
    background: #007bff;
    border: none;
    color: white;
    padding: 10px 15px;
    border-radius: 6px;
    cursor: pointer;
    font-weight: bold;
  }
  button:hover {
    background: #0056b3;
  }
  .checkbox-group {
    display: flex;
    align-items: center;
    gap: 8px;
  }
  .result-box {
    margin-top: 25px;
    background: #eef6ff;
    padding: 20px;
    border-radius: 8px;
  }
  table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 20px;
  }
  th,
  td {
    border: 1px solid #ccc;
    padding: 10px;
    text-align: center;
  }
  th {
    background: #0056b3;
    color: white;
  }
  .ok {
    color: green;
    font-weight: bold;
  }
  .pending {
    color: red;
    font-weight: bold;
  }
  .warning {
    color: orange;
    font-weight: bold;
  }
  .alerta {
    background: #fff3cd;
    color: #856404;
    border: 1px solid #ffeeba;
    padding: 10px;
    border-radius: 5px;
    margin-top: 15px;
  }
</style>
</head>
<body>
  <div class="container">
    <h1>Guía PNA de Tomas de Muestra</h1>
    <p class="autor">Creado por: Eu. Carlos Andrade</p>

    <div class="input-group">
      <label for="unidadIngreso">Unidad de Ingreso:</label>
      <select id="unidadIngreso">
        <option value="cuidados_basicos">Puerperio/Puericultura/Cuidados Básicos</option>
        <option value="uti_uci">UTI-UCI</option>
      </select>
    </div>

    <div class="input-group">
      <label for="edadGestacional">Edad Gestacional (semanas):</label>
      <input type="number" id="edadGestacional" min="20" max="45" value="38" />
    </div>

    <div class="input-group">
      <label for="pesoNacimiento">Peso de Nacimiento (gramos):</label>
      <input type="number" id="pesoNacimiento" min="500" max="6000" value="3000" />
    </div>

    <div id="condicionales-uti-uci" style="display: none;">
      <div class="input-group checkbox-group">
        <input type="checkbox" id="recibioM0" />
        <label for="recibioM0">¿Recibió Muestra 0 (M0)?</label>
      </div>
      <div class="input-group checkbox-group" id="m0-tiempo-group" style="display: none;">
        <input type="checkbox" id="m0Menos40h" />
        <label for="m0Menos40h">¿Muestra M0 fue tomada &lt; 40h de vida?</label>
      </div>
      <div class="input-group checkbox-group">
        <input type="checkbox" id="transfusionPreviaM1" />
        <label for="transfusionPreviaM1">¿Transfusión previa a M1?</label>
      </div>
      <div class="input-group checkbox-group">
        <input type="checkbox" id="pesquisaDudosaM1" />
        <label for="pesquisaDudosaM1">¿Pesquisa dudosa en M1?</label>
      </div>
    </div>

    <div id="condicionales-m3a" style="display: none;">
      <div class="input-group checkbox-group">
        <input type="checkbox" id="muestraPreviaAltaMenos10Dias" />
        <label for="muestraPreviaAltaMenos10Dias">¿Muestra previa al alta &lt; 10 días de vida?</label>
      </div>
      <div class="input-group checkbox-group">
        <input type="checkbox" id="transfusionMenos7Dias" />
        <label for="transfusionMenos7Dias">¿Transfusión &lt; 7 días desde muestra previa?</label>
      </div>
    </div>

    <div class="input-group checkbox-group">
      <input type="checkbox" id="sindromeDown" />
      <label for="sindromeDown">¿Diagnóstico o sospecha de Síndrome de Down?</label>
    </div>

    <div class="input-group">
      <label for="fechaNacimiento">Fecha de Nacimiento:</label>
      <input type="date" id="fechaNacimiento" />
    </div>

    <h3>Fechas de toma de muestras realizadas (si ya las tienen)</h3>
    <div class="input-group">
      <label for="fechaM0">Muestra 0 (M0):</label>
      <input type="date" id="fechaM0" />
    </div>
    <div class="input-group">
      <label for="fechaM1">Muestra 1 (M1):</label>
      <input type="date" id="fechaM1" />
    </div>
    <div class="input-group">
      <label for="fechaM2">Muestra 2 (M2):</label>
      <input type="date" id="fechaM2" />
    </div>
    <div class="input-group">
      <label for="fechaM3">Muestra 3 (M3):</label>
      <input type="date" id="fechaM3" />
    </div>

    <div class="input-group">
      <button id="calcularBtn">Calcular Recomendación</button>
    </div>

    <div class="result-box" id="resultados">
      <p>Introduce los datos y haz clic en "Calcular Recomendación".</p>
    </div>
  </div>

  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const unidad = document.getElementById("unidadIngreso");
      const edadGestacional = document.getElementById("edadGestacional");
      const peso = document.getElementById("pesoNacimiento");
      const sindromeDown = document.getElementById("sindromeDown");
      const condUti = document.getElementById("condicionales-uti-uci");
      const condM3a = document.getElementById("condicionales-m3a");
      const recibioM0 = document.getElementById("recibioM0");
      const m0Tiempo = document.getElementById("m0-tiempo-group");
      const m0Menos40h = document.getElementById("m0Menos40h");
      const transfusionPreviaM1 = document.getElementById("transfusionPreviaM1");
      const pesquisaDudosaM1 = document.getElementById("pesquisaDudosaM1");
      const muestraPreviaAltaMenos10Dias = document.getElementById("muestraPreviaAltaMenos10Dias");
      const transfusionMenos7Dias = document.getElementById("transfusionMenos7Dias");
      const fechaNacimiento = document.getElementById("fechaNacimiento");
      const resultadosDiv = document.getElementById("resultados");

      const fechasTomadas = {
        M0: document.getElementById("fechaM0"),
        M1: document.getElementById("fechaM1"),
        M2: document.getElementById("fechaM2"),
        M3: document.getElementById("fechaM3"),
      };

      const actualizarCondicionales = () => {
        const esUti = unidad.value === "uti_uci";
        condUti.style.display = esUti ? "block" : "none";
        condM3a.style.display = esUti ? "block" : "none";
        m0Tiempo.style.display = esUti && recibioM0.checked ? "flex" : "none";
      };
      unidad.addEventListener("change", actualizarCondicionales);
      recibioM0.addEventListener("change", actualizarCondicionales);
      actualizarCondicionales();

      const diasEntre = (f1, f2) => {
        if (!f1 || !f2) return NaN;
        return (new Date(f2) - new Date(f1)) / (1000 * 60 * 60 * 24);
      };

      const sumarDias = (fechaStr, dias) => {
        if (!fechaStr) return null;
        const fecha = new Date(fechaStr);
        fecha.setDate(fecha.getDate() + dias);
        return fecha.toISOString().slice(0, 10);
      };

      const edadEnDias = (fecha) => diasEntre(fechaNacimiento.value, fecha);

      const validarInputs = () => {
        if (!fechaNacimiento.value) return "Debes ingresar la Fecha de Nacimiento.";
        if (isNaN(parseInt(edadGestacional.value))) return "Edad gestacional inválida.";
        if (isNaN(parseInt(peso.value))) return "Peso inválido.";
        return null;
      };

      document.getElementById("calcularBtn").addEventListener("click", () => {
        const error = validarInputs();
        if (error) return resultadosDiv.innerHTML = `<p class="alerta">⚠️ ${error}</p>`;

        const esUti = unidad.value === "uti_uci";
        const eg = parseInt(edadGestacional.value);
        const pesoVal = parseInt(peso.value);
        const nac = fechaNacimiento.value;

        let muestras = [];
        let alertas = [];

        if (!esUti) {
          muestras.push({ id: "M1", descripcion: "Primera muestra entre 40–48 h", diaRecomendado: 2 });
          if (eg < 37 || pesoVal < 2500)
            muestras.push({ id: "M2", descripcion: "Segunda muestra a los 15 días (pretérmino o bajo peso)", diaRecomendado: 15 });
          if (sindromeDown.checked)
            muestras.push({ id: "M3", descripcion: "Tercera muestra a los 28 días (Síndrome de Down)", diaRecomendado: 28 });
        } else {
          muestras.push({ id: "M0", descripcion: "Muestra al ingreso (día 0)", diaRecomendado: 0 });
          if (recibioM0.checked && m0Menos40h.checked)
            muestras.push({ id: "M1", descripcion: "Nueva muestra entre 48 y 72h si M0 fue <40h", diaRecomendado: 3 });
          else if (!recibioM0.checked)
            muestras.push({ id: "M1", descripcion: "Muestra entre 40–48h (sin M0 previa)", diaRecomendado: 2 });

          if ((transfusionPreviaM1.checked || pesquisaDudosaM1.checked) && fechasTomadas.M1.value)
            muestras.push({ id: "M2", descripcion: "Muestra a los 15 días desde M1 por transfusión/pesquisa dudosa", diaRecomendado: edadEnDias(fechasTomadas.M1.value) + 15 });
          else if (eg < 37 || pesoVal < 2500)
            muestras.push({ id: "M2", descripcion: "Muestra a los 15 días (pretérmino o bajo peso)", diaRecomendado: 15 });

          if (muestraPreviaAltaMenos10Dias.checked && transfusionMenos7Dias.checked && fechasTomadas.M2.value)
            muestras.push({ id: "M3a", descripcion: "Repetir muestra (M3a) por transfusión reciente", diaRecomendado: edadEnDias(fechasTomadas.M2.value) + 7 });

          if (sindromeDown.checked && fechasTomadas.M2.value && edadEnDias(fechasTomadas.M2.value) < 21)
            muestras.push({ id: "M3b", descripcion: "Nueva muestra a los 28 días (Síndrome de Down y muestra previa <21 días)", diaRecomendado: 28 });
        }

        // Validar si hay fechas tomadas que no corresponden o fuera de rango
        const esFechaCorrecta = (fechaTomada, diaRecomendado) => {
          if (!fechaTomada) return false;
          const diff = Math.abs(edadEnDias(fechaTomada) - diaRecomendado);
          return diff <= 1;
        };

        const muestrasValidas = muestras.map(m => m.id);
        ["M0","M1","M2","M3"].forEach(id => {
          const fechaT = fechasTomadas[id].value;
          if (fechaT) {
            if (!muestrasValidas.includes(id)) {
              alertas.push(`⚠️ La muestra ${id} no corresponde según el algoritmo.`);
            } else {
              const mObj = muestras.find(m => m.id === id);
              if (!esFechaCorrecta(fechaT, mObj.diaRecomendado)) {
                alertas.push(`⚠️ La muestra ${id} fue tomada fuera del rango recomendado.`);
              }
            }
          }
        });

        // Texto descriptivo
        let texto = `<p><strong>Recomendación:</strong> Este recién nacido tiene indicación para las muestras ${muestras.map(m=>m.id).join(", ")}.</p>`;
        muestras.forEach(m => {
          const fechaRec = sumarDias(nac, m.diaRecomendado);
          texto += `<p>La ${m.id} (${m.descripcion}) se recomienda alrededor del ${fechaRec}.</p>`;
        });

        if (alertas.length) texto += `<div class="alerta">${alertas.join("<br>")}</div>`;

        // Tabla de control
        let html = `${texto}<table><thead><tr>
        <th>Muestra</th><th>Descripción</th><th>Día recomendado</th><th>Fecha recomendada</th><th>Fecha tomada</th><th>Estado</th></tr></thead><tbody>`;

        muestras.forEach(m => {
          const fechaRec = sumarDias(nac, m.diaRecomendado);
          const fechaT = fechasTomadas[m.id].value || "-";
          let estado = "Pendiente", clase="pending";
          if (fechaT !== "-") {
            if (esFechaCorrecta(fechaT, m.diaRecomendado)) { estado="Correcta"; clase="ok"; }
            else { estado="⚠️ Desviada"; clase="warning"; }
          }
          html += `<tr><td>${m.id}</td><td>${m.descripcion}</td><td>${m.diaRecomendado}</td><td>${fechaRec}</td><td>${fechaT}</td><td class="${clase}">${estado}</td></tr>`;
        });

        html += "</tbody></table>";
        resultadosDiv.innerHTML = html;
      });
    });
  </script>
</body>
</html>
