<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Recomendación de Muestras Neonatales</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    label { display: block; margin-top: 10px; }
    input[type="date"] { margin-left: 10px; }
    .error { color: red; }
    .advertencia { color: orange; }
    .tomada { color: green; }
    .pendiente { color: darkred; }
    table { border-collapse: collapse; margin-top: 20px; width: 100%; }
    th, td { border: 1px solid #aaa; padding: 8px; text-align: left; }
    th { background-color: #ddd; }
    #m0TiempoGroup { margin-left: 20px; display: none; }
  </style>
</head>
<body>

  <h2>Recomendación de toma de muestras neonatales</h2>

  <label for="unidadIngreso">Unidad de ingreso:</label>
  <select id="unidadIngreso">
    <option value="cuidados_basicos">Cuidados básicos (Puerperio-Puericultura)</option>
    <option value="uti_uci">UTI-UCI</option>
  </select>

  <label>
    Edad gestacional (semanas): 
    <input type="number" id="edadGestacional" min="20" max="45" />
  </label>

  <label>
    Peso al nacer (gramos): 
    <input type="number" id="pesoNacimiento" min="500" max="6000" />
  </label>

  <label>
    Fecha de nacimiento: 
    <input type="date" id="fechaNacimiento" />
  </label>

  <fieldset style="margin-top: 15px;">
    <legend>Condiciones especiales (marque si aplica)</legend>

    <label><input type="checkbox" id="recibioM0" /> Recibió muestra 0</label>
    <div id="m0TiempoGroup">
      <label><input type="checkbox" id="m0Menos40h" /> M0 tomada antes de 40h</label>
    </div>

    <label><input type="checkbox" id="transfusionPreviaM1" /> Transfusión previa a M1</label>
    <label><input type="checkbox" id="pesquisaDudosaM1" /> Pesquisa neonatal dudosa en M1</label>
    <label><input type="checkbox" id="muestraPreviaAltaMenos10Dias" /> Muestra previa al alta tomada antes de 10 días</label>
    <label><input type="checkbox" id="transfusionMenos7Dias" /> Transfusión en menos de 7 días desde muestra previa</label>
    <label><input type="checkbox" id="sindromeDown" /> Diagnóstico o sospecha de Síndrome de Down</label>
    <label><input type="checkbox" id="muestraPreviaAltaMenos21Dias" /> Muestra previa al alta tomada antes de 21 días</label>
  </fieldset>

  <fieldset style="margin-top: 15px;">
    <legend>Fechas de toma de muestras realizadas (si ya las tienen)</legend>
    <label>M0: <input type="date" id="fechaM0" /></label>
    <label>M1: <input type="date" id="fechaM1" /></label>
    <label>M2: <input type="date" id="fechaM2" /></label>
    <label>M3a: <input type="date" id="fechaM3a" /></label>
    <label>M3b: <input type="date" id="fechaM3b" /></label>
  </fieldset>

  <button id="calcularBtn" style="margin-top: 20px;">Calcular recomendación</button>

  <div id="resultados" style="margin-top: 30px;"></div>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const unidadIngresoSelect = document.getElementById("unidadIngreso");
  const recibioM0Checkbox = document.getElementById("recibioM0");
  const m0TiempoGroupDiv = document.getElementById("m0TiempoGroup");
  const m0Menos40hCheckbox = document.getElementById("m0Menos40h");
  const calcularBtn = document.getElementById("calcularBtn");
  const resultadosDiv = document.getElementById("resultados");
  const edadGestacionalInput = document.getElementById("edadGestacional");
  const pesoNacimientoInput = document.getElementById("pesoNacimiento");
  const fechaNacimientoInput = document.getElementById("fechaNacimiento");

  function actualizarVisibilidadCampos() {
    if (unidadIngresoSelect.value === "uti_uci" && recibioM0Checkbox.checked) {
      m0TiempoGroupDiv.style.display = "block";
    } else {
      m0TiempoGroupDiv.style.display = "none";
      m0Menos40hCheckbox.checked = false;
    }
  }
  unidadIngresoSelect.addEventListener("change", actualizarVisibilidadCampos);
  recibioM0Checkbox.addEventListener("change", actualizarVisibilidadCampos);
  actualizarVisibilidadCampos();

  function diffDias(fecha1, fecha2) {
    const _MS_PER_DAY = 1000 * 60 * 60 * 24;
    const utc1 = Date.UTC(fecha1.getFullYear(), fecha1.getMonth(), fecha1.getDate());
    const utc2 = Date.UTC(fecha2.getFullYear(), fecha2.getMonth(), fecha2.getDate());
    return Math.round((utc2 - utc1) / _MS_PER_DAY);
  }

  function getFechaMuestra(id) {
    const fechaInput = document.getElementById("fecha" + id);
    return fechaInput && fechaInput.value ? new Date(fechaInput.value) : null;
  }

  function calcularRecomendacion() {
    resultadosDiv.innerHTML = "";

    const unidad = unidadIngresoSelect.value;
    const eg = parseFloat(edadGestacionalInput.value);
    const pesoVal = parseFloat(pesoNacimientoInput.value);

    if (!fechaNacimientoInput.value) {
      resultadosDiv.innerHTML = '<p class="error">Por favor, ingrese la fecha de nacimiento.</p>';
      return;
    }
    if (isNaN(eg) || eg < 20 || eg > 45) {
      resultadosDiv.innerHTML = '<p class="error">Ingrese una edad gestacional válida (20-45 semanas).</p>';
      return;
    }
    if (isNaN(pesoVal) || pesoVal < 500 || pesoVal > 6000) {
      resultadosDiv.innerHTML = '<p class="error">Ingrese un peso válido (500-6000 gramos).</p>';
      return;
    }

    const fechaNacimiento = new Date(fechaNacimientoInput.value);

    // Fechas muestras existentes
    const fechaM0 = getFechaMuestra("M0");
    const fechaM1 = getFechaMuestra("M1");
    const fechaM2 = getFechaMuestra("M2");
    const fechaM3a = getFechaMuestra("M3a");
    const fechaM3b = getFechaMuestra("M3b");

    // Chequeos condicionales
    const recibioM0 = recibioM0Checkbox.checked;
    const m0Menos40h = m0Menos40hCheckbox.checked;
    const transfusionPreviaM1 = document.getElementById("transfusionPreviaM1").checked;
    const pesquisaDudosaM1 = document.getElementById("pesquisaDudosaM1").checked;
    const muestraPreviaAltaMenos10Dias = document.getElementById("muestraPreviaAltaMenos10Dias").checked;
    const transfusionMenos7Dias = document.getElementById("transfusionMenos7Dias").checked;
    const sindromeDown = document.getElementById("sindromeDown").checked;
    const muestraPreviaAltaMenos21Dias = document.getElementById("muestraPreviaAltaMenos21Dias").checked;

    let muestras = [];

    // M0: 48 a 72 horas (recomendado)
    if (!fechaM0) {
      muestras.push({
        id: "M0",
        diaMin: 2,
        diaMax: 3,
        desc: "Muestra 0 recomendada entre 48 y 72 horas de vida.",
        motivo: "Muestra inicial estándar."
      });
    } else {
      // chequeo si está dentro de rango recomendado
      const diasDesdeNacimientoM0 = diffDias(fechaNacimiento, fechaM0);
      if (diasDesdeNacimientoM0 < 2 || diasDesdeNacimientoM0 > 3) {
        muestras.push({
          id: "M0",
          diaMin: 2,
          diaMax: 3,
          desc: `Muestra 0 tomada el ${fechaM0.toISOString().slice(0,10)}, fuera del rango recomendado (48-72h).`,
          motivo: "Corregir tiempo de toma de M0."
        });
      }
    }

    // M1: 7 a 10 días
    if (!fechaM1) {
      muestras.push({
        id: "M1",
        diaMin: 7,
        diaMax: 10,
        desc: "Muestra 1 recomendada entre 7 y 10 días de vida.",
        motivo: "Muestra de seguimiento estándar."
      });
    }

    // M2: 21 días (solo si transfusión previa a M1)
    if (transfusionPreviaM1) {
      if (!fechaM2) {
        muestras.push({
          id: "M2",
          diaMin: 21,
          diaMax: 21,
          desc: "Muestra 2 recomendada a los 21 días de vida.",
          motivo: "Transfusión previa a M1 requiere M2."
        });
      }
    }

    // M3a: Si muestra previa al alta tomada antes de 10 días y bajo peso, pretérmino o transfusión reciente menos de 7 días
    if (muestraPreviaAltaMenos10Dias && (pesoVal < 2500 || eg < 37 || transfusionMenos7Dias)) {
      if (!fechaM3a) {
        muestras.push({
          id: "M3a",
          diaMin: 15,
          diaMax: 15,
          desc: "Muestra 3a recomendada a los 15 días de vida.",
          motivo: "Muestra previa al alta antes de 10 días con bajo peso, pretérmino o transfusión reciente."
        });
      }
    }

    // M3b: Síndrome de Down con muestra previa al alta antes de 21 días
    if (sindromeDown && muestraPreviaAltaMenos21Dias) {
      if (!fechaM3b) {
        muestras.push({
          id: "M3b",
          diaMin: 21,
          diaMax: 25,
          desc: "Muestra 3b recomendada entre 21 y 25 días de vida.",
          motivo: "Síndrome de Down con muestra previa al alta antes de 21 días."
        });
      }
    }

    // Mostrar resumen con tabla y mensajes
    if (muestras.length === 0) {
      resultadosDiv.innerHTML = '<p class="tomada">No hay muestras pendientes o recomendaciones nuevas.</p>';
      return;
    }

    // Crear tabla de recomendaciones
    let html = '<table><thead><tr><th>Muestra</th><th>Descripción</th><th>Motivo</th></tr></thead><tbody>';

    muestras.forEach(m => {
      html += `<tr>
        <td>${m.id}</td>
        <td>${m.desc}</td>
        <td>${m.motivo}</td>
      </tr>`;
    });

    html += '</tbody></table>';

    resultadosDiv.innerHTML = html;
  }

  calcularBtn.addEventListener("click", calcularRecomendacion);
});
</script>

</body>
</html>

